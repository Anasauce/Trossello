#!/usr/bin/env node

require('../config/environment')
const fs = require('fs');
const path = require('path');
const childProcess = require('child_process');

process.chdir(path.resolve(__dirname, '..'));

const spawn = (cmd, args) => {
  return childProcess.spawn(cmd, args, {stdio: 'inherit'})
}



const waitForServerToExists = (callback) => {
  fs.lstat('./build/server/index.js', (error, stats) => {
    if (stats)
      callback()
    else
      waitForServerToExists(callback)
  })
}

const buildProcess = spawn('./bin/build', ['-w'])
waitForServerToExists(() => {

  if (process.env.NODE_ENV === 'development'){
    spawn('nodemon', ['./build/server', '--watch', './build/server'])
  }else{
    spawn('node', ['./build/server'])
  }

})
